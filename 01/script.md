「まさか, 商店街近くにこんな穴場があるとは…

「ランチもおいしいんですよー

「うーん, 私はコーヒーパフェにでもしますか

「えー, もうちょっと甘味とかにしましょーよー

「ちょっと高いので…

「じゃあ, 今日は私のおごりにするから〜♪

「珍しいですね, 何かあったんですか

「いやその, せっかくだから聞きたいこととかあるし…授業料みたいなもんですよ！

(さては食べ比べしたいだけですね…

「じゃあお言葉に甘えますか

「すいませーん！クリームあんみつと宇治金時で！

(待てよ, 財布に樋口あったっけ…

*OP*

「それで, 聞きたいことがあるんでしたね

「えっとね, Rust の `Option` とか `Result` の使い方がわかんない！

「あーなるほど…, まずは `Option` の定義から見ていきますか

「おっけー♪


「たしかこんな感じの定義でしたね

```rust
enum Option<T> {
  Some(T),
  None,
}
```

「そうそう, ソメとノンだよね

「サムとナンです…

「そ, そうとも言うし〜

「まぁ値が有るのか無いのかを示しているだけですね


「そしてこれが `Result` です

```rust
enum Result<T, E> {
  Ok(T),
  Err(E),
}
```

「よく関数の戻り値になってたりするやつだ

「ポジティブな情報である `Ok` か, ネガティブな情報である `Err` のどちらかですね

「ここまで簡潔に書かれちゃうと, 何ができるのかよくわかんなくなっちゃうー


`map`

「`Option` や `Result` にはいろいろ便利なメソッドが `impl` されてます. 代表的なものはやはり `map` でしょう

「あーこれこれ. 使ってるのみたことある

「ソースコードを見るとそのまんまですが, このように中身を取り出して渡された関数に入れています

```rust
impl<T> Option<T> {
  fn map<U, F: FnOnce(T) -> U>(self, f: F) -> Option<U> {
    match self {
      Some(x) => Some(f(x)),
      None => None,
    }
  }
}

impl<T, E> Result<T, E> {
  pub fn map<U, F: FnOnce(T) -> U>(self, op: F) -> Result<U, E> {
    match self {
      Ok(t) => Ok(op(t)),
      Err(e) => Err(e),
    }
  }
}
```

「あー, C++ の関数テンプレートとおんなじ感じだ

`as_ref` `as_mut` `as_deref`

「`map` はムーブして所有権を奪うようになっています. しかし `&Option<T>` を `Option<&T>` に変換するメソッドが提供されているのでこれを使えば大丈夫です

「ふーん, いっつも `clone` しちゃってたかも……

「`&Option<String>` を `Option<&str>` に変換するみたいな処理は, `map` しなくても `as_deref` でできます

「へぇ〜便利ぃ

`unwrap` `except` `unwrap_or` `unwrap_default`

「中身をそのまま取り出すときは `unwrap` 系の関数ですね

「ふむふむ……, `except` は何に使うの?

「これは取り出しに失敗すると指定のメッセージ付きでパニックするんです. 原因がわかりやすくなります

`and_then`

「中身の値から新しい `Option` や `Result` を作るときは `and_then` が便利ですね

「……これ要るの? 再代入してるだけじゃん

「じゃあちょっと再代入で表現してみましょうか

「えーと, こんな感じかな?

「もうちょっと処理を増やしてみますか

「仮の関数だらけだけど, こうしてみたよ

「そうやっていろんな処理をつなぎ始めると, 取り出す処理も増えていきます

「あぁ, やっぱり取り出すとこはそれを持ってる方がやれば楽なんだねー

`ok_or` `ok` `err`

「最後に, `Option` と `Result` の相互変換を提供する関数です

「おー, いつでも取っ換えられるんだ


「他にもいろいろ便利な関数が用意されてますから, `doc.rust-lang.org` で検索してみてください

「そいで結局, `Option` と `Result` はどっち使えばいいの?

「まぁ基本的には `Result` で, 提供できるエラーの情報がどうしても無いなら `Option` でしょう. それが存在しない理由が, 分かりきっている or 知りようが無いなら `Result` にする意味ないですし

「クリームあんみつと, 宇治金時になりまーす

「わー来た来た〜♪ いっただっきまーす!

*アイキャッチ*

「どんな関数のエラーも拾えるように, 最初から全部 `Result` だったらいいのに

「すべてのエラーがハンドリングできるとは限りませんよ

復帰可能性

「

パニック

「

`panic!` `unreachable!`


`assert!`

検査のコストと実行速度のトレードオフ

「

関手

「そういえば, `Option` の `map` のように中身の方を変換する機能を備えた型を関手といいます

モナド

---

動画: Mikuro さいな
監修: かわえもん

参考文献:

- The Rust Programming Language a.k.a. "The Book" https://doc.rust-lang.org/book/

---
